@using Domain
@using Microsoft.Web.Mvc;
@using Web.Areas.AnalysisManagement;

@section page_title{
Analysis: Symptom and Diagnosis Report
}

@{
    Html.RenderPartial("_EmptySubNavigation");
    Html.RenderPartial("_AnalysisSideBar");
}
<script type="text/javascript">

    Ext.onReady(function () {

        var analysisBtnId = window.res.header.navigation.analysisAndReports;
        var analysisBtn = Ext.getCmp(analysisBtnId);
        analysisBtn.toggle(true);

        var reportBtnId = window.res.content.maincontent.sidebar.diagnoisreport;
        var reportBtn = Ext.getCmp(reportBtnId);
        reportBtn.toggle(true);
    });

</script>
<script type="text/javascript">
    var allowUserToClearValue = {
        'load': function () {
            //this.insert(0, {Id:'@Guid.Empty', Name:'All'});
        }
    };
    Ext.onReady(function () {
        window.feature = {};
        window.feature.countryComboboxId = 'Overview-Combobox-Country-Diagnosis-Report';
        window.feature.regionComboboxId = 'Overview-Combobox-Region-Diagnosis-Report';
        window.feature.districtComboboxId = 'Overview-Combobox-District-Diagnosis-Report';
        window.feature.StartDateId = 'Overview-Start-Date-Diagnosis-Report';
        window.feature.EndDateId = 'Overview-End-Date-Diagnosis-Report';
        window.feature.modalCountryComboboxId = 'Overview-Window-Combobox-Country-Diagnosis-Report';
        window.feature.modalRegionComboboxId = 'Overview-Window-Combobox-Region-Diagnosis-Report';
        window.feature.modalDistrictComboboxId = 'Overview-Window-Combobox-District-Diagnosis-Report';
        window.feature.modalStartDateId = 'Overview-Window-Start-Date-Diagnosis-Report';
        window.feature.modalEndDateId = 'Overview-Window-End-Date-Diagnosis-Report';
        window.feature.DivChartContainer = 'Chart-Diagnosis-Report-Container-Id';
        window.feature.chartSymptomContainerId = 'div-chart-container-symptom';
        window.feature.chartDiagnosisContainerId = 'div-chart-container-diagnosis';
        window.feature.exportStartDate = "";
        window.feature.exportEndDate = "";

        window.feature.reportStore = Ext.create('Ext.data.Store', {
            fields: ['Diagnosis', 'Outpost', 'Female', 'Male', 'NumberOfPatients'],
            groupField: 'Diagnosis',
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "DiagnosisReport", action = "GetDiagnosisReport" })',
                reader: {
                    type: 'json',
                    root: 'Diagnosis',
                    totalProperty: 'TotalItems'
                },
                extraParams: {
                    countryId: '',
                    regionId: '',
                    districtId: '',
                    startDate: '',
                    endDate: ''
                },
                simpleSortMode: true
            },
            sorters: [{
                property: 'Diagnosis',
                direction: 'ASC'
            }]
        });
        
        window.feature.symptomReportStore = Ext.create('Ext.data.Store', {
            fields: ['Symptom', 'Outpost', 'Female', 'Male', 'NumberOfPatients'],
            groupField: 'Symptom',
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "SymptomsReport", action = "GetSymptomsReport" })',
                reader: {
                    type: 'json',
                    root: 'Symptoms',
                    totalProperty: 'TotalItems'
                },
                extraParams: {
                    countryId: '',
                    regionId: '',
                    districtId: '',
                    startDate: '',
                    endDate: ''
                },
                simpleSortMode: true
            },
            sorters: [{
                property: 'Symptom',
                direction: 'ASC'
            }]
        });

        var myDiagMask = '';
        window.feature.chartStore = Ext.create('Ext.data.Store', {
            fields: [
                { name: 'Diagnosis' },
                { name: 'Female', type: 'int' },
                { name: 'Male', type: 'int' }
            ],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "DiagnosisReport", action = "GetChartData" })',
                reader: {
                    type: 'json',
                    root: 'Diagnosis',
                    totalProperty: 'TotalItems'
                },
                extraParams: {
                    countryId: '',
                    regionId: '',
                    districtId: '',
                    startDate: '',
                    endDate: ''
                },
                simpleSortMode: true
            },
            sorters: [{
                property: 'Diagnosis',
                direction: 'ASC'
            }],
            listeners: {
                'load': function (store, records, options) {
                    DrawChart();

                    window.feature.reportStore.proxy.extraParams.countryId = window.feature.chartStore.proxy.extraParams.countryId;
                    window.feature.reportStore.proxy.extraParams.regionId = window.feature.chartStore.proxy.extraParams.regionId;
                    window.feature.reportStore.proxy.extraParams.districtId = window.feature.chartStore.proxy.extraParams.districtId;
                    window.feature.reportStore.proxy.extraParams.startDate = window.feature.chartStore.proxy.extraParams.startDate;
                    window.feature.reportStore.proxy.extraParams.endDate = window.feature.chartStore.proxy.extraParams.endDate;

                    myDiagMask.hide();
                },
                'beforeload': function(store, operation, options){
                    var cont = Ext.getCmp(window.feature.chartDiagnosisContainerId);
                    myDiagMask = new Ext.LoadMask(cont, { msg: 'Please wait...' });
                    myDiagMask.show();
                }
            }
        });

        var mySympMask = '';
        window.feature.symptomsStore = Ext.create('Ext.data.Store', {
            fields: [
                { name: 'Symptom' },
                { name: 'Female', type: 'int' },
                { name: 'Male', type: 'int' }
            ],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "SymptomsReport", action = "GetChartData" })',
                reader: {
                    type: 'json',
                    root: 'Symptoms',
                    totalProperty: 'TotalItems'
                },
                extraParams: {
                    countryId: '',
                    regionId: '',
                    districtId: '',
                    startDate: '',
                    endDate: ''
                },
                simpleSortMode: true
            },
            sorters: [{
                property: 'Symptom',
                direction: 'ASC'
            }],
            listeners: {
                'load': function (store, records, options) {
                    DrawChart();

                    window.feature.symptomReportStore.proxy.extraParams.countryId = window.feature.symptomsStore.proxy.extraParams.countryId;
                    window.feature.symptomReportStore.proxy.extraParams.regionId =  window.feature.symptomsStore.proxy.extraParams.regionId;
                    window.feature.symptomReportStore.proxy.extraParams.districtId =window.feature.symptomsStore.proxy.extraParams.districtId;
                    window.feature.symptomReportStore.proxy.extraParams.startDate = window.feature.symptomsStore.proxy.extraParams.startDate;
                    window.feature.symptomReportStore.proxy.extraParams.endDate =   window.feature.symptomsStore.proxy.extraParams.endDate;

                    mySympMask.hide();
                },
                'beforeload': function(store, operation, options){
                    var cont = Ext.getCmp(window.feature.chartSymptomContainerId);
                    mySympMask = new Ext.LoadMask(cont, { msg: 'Please wait...' });
                    mySympMask.show();
                }
            }
        });


        window.feature.countryStore = Ext.create('Ext.data.Store', {
            remoteSort: true,
            fields: ['Id', 'Name'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(Web.Areas.LocationManagement.LocationManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "Region", action = "GetCountries" })',
                reader: {
                    type: 'json',
                    root: 'Countries',
                    totalProperty: 'TotalItems'
                },
                simpleSortMode: true
            },
            sorters: [{
                property: 'Name',
                direction: 'ASC'
            }]
        });

        window.feature.regionStore = Ext.create('Ext.data.Store', {
            remoteSort: true,
            fields: ['Id', 'Name'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(Web.Areas.LocationManagement.LocationManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "District", action = "GetRegions" })',
                reader: {
                    type: 'json',
                    root: 'regions',
                    totalProperty: 'TotalItems'
                },
                extraParams: { countryId: '' },
                simpleSortMode: true
            },
            sorters: [{
                property: 'Name',
                direction: 'ASC'
            }]
        });

        window.feature.districtStore = Ext.create('Ext.data.Store', {
            remoteSort: true,
            fields: ['Id', 'Name'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(Web.Areas.LocationManagement.LocationManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "Outpost", action = "GetDistricts" })',
                reader: {
                    type: 'json',
                    root: 'Districts',
                    totalProperty: 'TotalItems'
                },
                extraParams: { regionId: '' },
                simpleSortMode: true
            },
            sorters: [{
                property: 'Name',
                direction: 'ASC'
            }]
        });

        function ResetCountryOverviewDependencies() {
            var regionCombobox = window.feature.container.down('#' + window.feature.regionComboboxId);
            regionCombobox.setValue(null);

            var districtCombobox = window.feature.container.down('#' + window.feature.districtComboboxId);
            districtCombobox.setValue(null);

            window.feature.chartStore.proxy.extraParams.regionId = "";
            window.feature.chartStore.proxy.extraParams.districtId = "";
            window.feature.symptomsStore.proxy.extraParams.regionId = "";
            window.feature.symptomsStore.proxy.extraParams.districtId = "";
        };

        function ResetRegionOverviewDependencies() {
            var districtCombobox = window.feature.container.down('#' + window.feature.districtComboboxId);
            districtCombobox.setValue(null);

            window.feature.chartStore.proxy.extraParams.districtId = "";
            window.feature.symptomsStore.proxy.extraParams.districtId = "";
        };

        window.feature.countryCombobox = Ext.create('Ext.form.ComboBox', {
            xtype: 'combobox',
            itemId: window.feature.countryComboboxId,
            store: window.feature.countryStore,
            width: 170,
            labelAlign: 'top',
            fieldLabel: 'Selected Country',
            displayField: 'Name',
            valueField: 'Id',
            labelClsExtra: 'combo-label',
            emptyText: 'Country List',
            editable: true,
            typeAhead: true,
            listeners: {
                'select': function (combo, record) {
                    ResetCountryOverviewDependencies();

                    window.feature.regionStore.proxy.extraParams.countryId = combo.getValue();
                    window.feature.regionStore.load();
                    
                    window.feature.chartStore.proxy.extraParams.countryId = combo.getValue();
                    window.feature.chartStore.load();
                    
                    window.feature.symptomsStore.proxy.extraParams.countryId = combo.getValue();
                    window.feature.symptomsStore.load();
                },
                specialkey: function (field, e) {
                    if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                        field.setValue(null);
                        ResetCountryOverviewDependencies();
                        window.feature.chartStore.proxy.extraParams.countryId = '';
                        window.feature.chartStore.load();
                        window.feature.symptomsStore.proxy.extraParams.countryId = '';
                        window.feature.symptomsStore.load();
                    }
                }
            }
        });
        window.feature.regionCombobox = Ext.create('Ext.form.ComboBox', {
            xtype: 'combobox',
            itemId: window.feature.regionComboboxId,
            store: window.feature.regionStore,
            width: 170,
            labelAlign: 'top',
            fieldLabel: 'Selected Region',
            displayField: 'Name',
            valueField: 'Id',
            labelClsExtra: 'combo-label',
            emptyText: 'Region List',
            editable: true,
            typeAhead: true,
            listeners: {
                'select': function (combo, record) {
                    ResetRegionOverviewDependencies();

                    window.feature.districtStore.proxy.extraParams.regionId = combo.getValue();
                    window.feature.districtStore.load();

                    window.feature.chartStore.proxy.extraParams.regionId = combo.getValue();
                    window.feature.chartStore.load();
                    window.feature.symptomsStore.proxy.extraParams.regionId = combo.getValue();
                    window.feature.symptomsStore.load();
                },
                specialkey: function (field, e) {
                    if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                        field.setValue(null);
                        ResetRegionOverviewDependencies();
                        window.feature.chartStore.proxy.extraParams.regionId = '';
                        window.feature.chartStore.load();
                        window.feature.symptomsStore.proxy.extraParams.regionId = '';
                        window.feature.symptomsStore.load();
                    }
                }
            }
        });

        window.feature.districtCombobox = Ext.create('Ext.form.ComboBox', {
            xtype: 'combobox',
            itemId: window.feature.districtComboboxId,
            store: window.feature.districtStore,
            width: 170,
            labelAlign: 'top',
            fieldLabel: 'Selected District',
            displayField: 'Name',
            labelClsExtra: 'combo-label',
            valueField: 'Id',
            emptyText: 'District List',
            editable: true,
            typeAhead: true,
            listeners: {
                'select': function (combo, record) {
                    window.feature.chartStore.proxy.extraParams.districtId = combo.getValue();
                    window.feature.chartStore.load();
                    window.feature.symptomsStore.proxy.extraParams.districtId = combo.getValue();
                    window.feature.symptomsStore.load();
                },
                specialkey: function (field, e) {
                    if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                        field.setValue(null);
                        window.feature.chartStore.proxy.extraParams.districtId = '';
                        window.feature.chartStore.load();
                        window.feature.symptomsStore.proxy.extraParams.districtId = '';
                        window.feature.symptomsStore.load();
                    }
                }
            }
        });

        Ext.define('Ext.chart.theme.MyTheme', {
            extend: 'Ext.chart.theme.Base',
            colors: ['rgb(255, 	130, 	171)', 'rgb(126, 	192, 	238)'],
            constructor: function (config) {
                this.callParent([Ext.apply({
                    colors: this.colors
                }, config)]);
            }
        });

        window.feature.chartContainer = Ext.create('Ext.container.Container', {
            minHeight: 600,
            minWidth: 1100,
            layout: {
                align: 'stretch',
                type: 'hbox'
            },
            scrollable:true,
            autoScroll: true,
            items:[{
                xtype: 'container',
                flex: 1,
                id: window.feature.chartSymptomContainerId,
                layout: {
                    type: 'fit'
                },
                items: []
            }, {
                xtype: 'container',
                flex: 1,
                id: window.feature.chartDiagnosisContainerId,
                layout: {
                    type: 'fit'
                },
                items: []
            }]
        });

        function DrawChart() {
            var symcont = Ext.getCmp(window.feature.chartSymptomContainerId);
            var chart = Ext.getCmp('chartIdRemove');
            symcont.remove(chart);

            var diagcont = Ext.getCmp(window.feature.chartDiagnosisContainerId);
            var chartS = Ext.getCmp('chartSymptoms');
            diagcont.remove(chartS);

            symcont.add({
                id: 'chartSymptoms',
                xtype: 'chart',
                animate: true,
                shadow: true,
                flex: 1,
                store: window.feature.symptomsStore,
                theme: 'MyTheme',
                axes: [{
                    type: 'Category',
                    position: 'bottom',
                    fields: ['Symptom'],
                    title: 'Symptoms',
                    label: {
                        orientation: 'horizontal',
                        rotate: {
                            degrees: 60,
                        },
                    },
                }, {
                    type: 'Numeric',
                    position: 'left',
                    fields: ['Female', 'Male'],
                    title: 'Number of patients',
                    grid: true,
                    minimum: 0,
                    maximum: GetMaxSymptomValue(),
                    majorTickSteps: GetMaxSymptomValue() - 1
                }],
                series: [{
                    type: 'column',
                    axis: 'bottom',
                    highlight: true,
                    tips: {
                        trackMouse: true,
                        width: 140,
                        renderer: function (storeItem, item) {
                            this.setTitle(String(item.value[1]) + ' Patients - ' + item.value[0]);
                        }
                    },
                    xField: 'Symptom',
                    yField: ['Female', 'Male'],
                    stacked: true
                }],
                legend: {
                    position: 'right'
                }
            });
            

            diagcont.add({
                id: 'chartIdRemove',
                xtype: 'chart',
                flex: 1,
                animate: true,
                shadow: true,
                store: window.feature.chartStore,
                theme: 'MyTheme',
                axes: [{
                        type: 'Category',
                        position: 'bottom',
                        fields: ['Diagnosis'],
                        title: 'Diagnosis',
                        label: {
                            orientation: 'horizontal',
                            rotate: {
                                degrees: 60,
                            },
                        },
                    }, {
                        type: 'Numeric',
                        position: 'left',
                        fields: ['Female', 'Male'],
                        title: 'Number of patients',
                        grid: true,
                        minimum: 0,
                        maximum: GetTheBiggestValue(),
                        majorTickSteps: GetTheBiggestValue() - 1
                    }],
                series: [{
                    type: 'column',
                    axis: 'bottom',
                    highlight: true,
                    tips: {
                        trackMouse: true,
                        width: 140,
                        renderer: function(storeItem, item) {
                            this.setTitle(String(item.value[1]) + ' Patients - ' + item.value[0]);
                        }
                    },
                    xField: 'Diagnosis',
                    yField: ['Female', 'Male'],
                    stacked: true
                }],
                legend: {
                    position: 'right'
                }
            });
            
        };

        var showSummary = true;
        window.feature.modal = Ext.define('Ext.feature.DiagnosisReport.Modal', {
            extend: 'Ext.window.Window',
            modal: true,
            ui: 'snapshot-popup-window',
            title: 'Diagnosis Report',
            height: 700,
            width: 1055,
            layout: {
                align: 'stretch',
                padding: 10,
                type: 'vbox'
            },

            initComponent: function () {
                var me = this;
                var countryOverviewCombobox = window.feature.container.down('#' + window.feature.countryComboboxId);
                var regionOverviewCombobox = window.feature.container.down('#' + window.feature.regionComboboxId);
                var districtOverviewCombobox = window.feature.container.down('#' + window.feature.districtComboboxId);
                var startDateOverviewCombobox = window.feature.container.down('#' + window.feature.StartDateId);
                var endDateOverviewCombobox = window.feature.container.down('#' + window.feature.EndDateId);
                var outpostTypeOverviewCombobox = window.feature.container.down('#' + window.feature.outpostTypeComboboxId);

                Ext.applyIf(me, {
                    items: [{
                        xtype: 'container',
                        height: 65,
                        layout: 'fit',
                        items: [{
                            xtype: 'container',
                            height: 65,
                            autoScroll: true,
                            scrollable:true,
                            layout: {
                                align: 'stretch',
                                type: 'hbox'
                            },
                            padding: '0 0 0 7',
                            items: [{
                                xtype: 'combobox',
                                itemId: window.feature.modalCountryComboboxId,
                                store: window.feature.countryStore,
                                width: 170,
                                labelAlign: 'top',
                                fieldLabel: 'Selected Country',
                                displayField: 'Name',
                                valueField: 'Id',
                                labelClsExtra: 'combo-label',
                                emptyText: 'Country List',
                                value: countryOverviewCombobox.getValue(),
                                editable: true,
                                typeAhead: true,
                                listeners: {
                                    'select': function (combo, record) {
                                        ResetCountryOverviewDependencies();
                                        countryOverviewCombobox.setValue(combo.getValue());
                                        me.down('#' + window.feature.modalRegionComboboxId).setValue(null);
                                        me.down('#' + window.feature.modalDistrictComboboxId).setValue(null);

                                        window.feature.regionStore.proxy.extraParams.countryId = combo.getValue();
                                        window.feature.regionStore.load();

                                        window.feature.chartStore.proxy.extraParams.countryId = combo.getValue();
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.countryId = combo.getValue();
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            countryOverviewCombobox.setValue(null);
                                            ResetCountryOverviewDependencies();
                                            me.down('#' + window.feature.modalRegionComboboxId).setValue(null);
                                            me.down('#' + window.feature.modalDistrictComboboxId).setValue(null);
                                            window.feature.chartStore.load();
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }, {
                                xtype: 'combobox',
                                itemId: window.feature.modalRegionComboboxId,
                                store: window.feature.regionStore,
                                width: 170,
                                labelAlign: 'top',
                                fieldLabel: 'Selected Region',
                                displayField: 'Name',
                                valueField: 'Id',
                                labelClsExtra: 'combo-label',
                                emptyText: 'Region List',
                                value: regionOverviewCombobox.getValue(),
                                editable: true,
                                typeAhead: true,
                                listeners: {
                                    'select': function (combo, record) {
                                        ResetRegionOverviewDependencies();
                                        regionOverviewCombobox.setValue(combo.getValue());
                                        me.down('#' + window.feature.modalDistrictComboboxId).setValue(null);

                                        window.feature.districtStore.proxy.extraParams.regionId = combo.getValue();
                                        window.feature.districtStore.load();

                                        window.feature.chartStore.proxy.extraParams.regionId = combo.getValue();
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.regionId = combo.getValue();
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            ResetRegionOverviewDependencies();
                                            regionOverviewCombobox.setValue(null);
                                            me.down('#' + window.feature.modalDistrictComboboxId).setValue(null);
                                            window.feature.chartStore.load();
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }, {
                                xtype: 'combobox',
                                itemId: window.feature.modalDistrictComboboxId,
                                store: window.feature.districtStore,
                                width: 170,
                                labelAlign: 'top',
                                fieldLabel: 'Selected District',
                                displayField: 'Name',
                                labelClsExtra: 'combo-label',
                                valueField: 'Id',
                                emptyText: 'District List',
                                value: districtOverviewCombobox.getValue(),
                                editable: true,
                                typeAhead: true,
                                listeners: {
                                    'select': function (combo, record) {
                                        districtOverviewCombobox.setValue(combo.getValue());

                                        window.feature.chartStore.proxy.extraParams.districtId = combo.getValue();
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.districtId = combo.getValue();
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            districtOverviewCombobox.setValue(null);
                                            window.feature.chartStore.proxy.extraParams.districtId = "";
                                            window.feature.chartStore.load(); 
                                            window.feature.symptomsStore.proxy.extraParams.districtId = "";
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }, {
                                xtype: 'datefield',
                                fieldLabel: 'Start Date',
                                width: 170,
                                format: 'd-M-Y',
                                labelAlign: 'top',
                                itemId: window.feature.modalStartDateId,
                                value: startDateOverviewCombobox.getValue(),
                                listeners: {
                                    select: function (t, n, o) {
                                        var date = t.getValue();
                                        window.feature.exportStartDate = date;
                                        startDateOverviewCombobox.setValue(date);
                                        window.feature.chartStore.proxy.extraParams.startDate = date;
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.startDate = date;
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            startDateOverviewCombobox.setValue(null);
                                            window.feature.chartStore.proxy.extraParams.startDate = "";
                                            window.feature.symptomsStore.proxy.extraParams.startDate = "";
                                            window.feature.exportStartDate = "";
                                            window.feature.chartStore.load();
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }, {
                                xtype: 'datefield',
                                fieldLabel: 'End Date',
                                width: 170,
                                labelAlign: 'top',
                                format: 'd-M-Y',
                                itemId: window.feature.modalEndDateId,
                                value: endDateOverviewCombobox.getValue(),
                                listeners: {
                                    select: function (t, n, o) {
                                        var date = t.getValue();
                                        window.feature.exportEndDate = date;
                                        endDateOverviewCombobox.setValue(date);
                                        
                                        window.feature.chartStore.proxy.extraParams.endDate = date;
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.endDate = date;
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            endDateOverviewCombobox.setValue(null);
                                            window.feature.chartStore.proxy.extraParams.endDate = "";
                                            window.feature.symptomsStore.proxy.extraParams.endDate = "";
                                            window.feature.exportEndDate = "";
                                            window.feature.chartStore.load();
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }]
                        }]
                    },{
                        xtype: 'gridpanel',
                        cls: 'white-border',
                        store: window.feature.reportStore,
                        loadMask: true,
                        disableSelection: true,
                        flex: 3,
                        layout: 'fit',
                        autoScroll: true,
                        features: [{
                            id: 'group',
                            ftype: 'groupingsummary',
                            enableGroupingMenu: false
                        }],
                        columns: [{
                            header: "Diagnosis / Health Facility",
                            dataIndex: 'Outpost',
                            flex: 2,
                            minWidth: 200,
                            menuDisabled: true,
                            sortable: true
                        }, {
                            header: "Females",
                            dataIndex: 'Female',
                            flex: 1,
                            minWidth: 100,
                            menuDisabled: true,
                            sortable: true,
                            align: 'center',
                            summaryType: 'sum',
                            summaryRenderer: function (value, summaryData, dataIndex) {
                                return value + ' females';
                            },
                            field: {
                                xtype: 'numberfield'
                            }
                        }, {
                            header: "Males",
                            dataIndex: 'Male',
                            flex: 1,
                            minWidth: 100,
                            menuDisabled: true,
                            sortable: true,
                            align: 'center',
                            summaryType: 'sum',
                            summaryRenderer: function (value, summaryData, dataIndex) {
                                return value + ' males';
                            },
                            field: {
                                xtype: 'numberfield'
                            }
                        }, {
                            header: "Number Of Patients",
                            dataIndex: 'NumberOfPatients',
                            flex: 1,
                            minWidth: 150,
                            menuDisabled: true,
                            sortable: true,
                            align: 'center',
                            summaryType: 'sum',
                            summaryRenderer: function (value, summaryData, dataIndex) {
                                return value + ' patients';
                            },
                            field: {
                                xtype: 'numberfield'
                            }
                        }],
                        bbar: [{
                            xtype: 'button',
                            text: 'Export to Excel',
                            handler: function () {
                                DownloadFile();
                            }
                        }]
                    }]
                });

                me.callParent(arguments);
            }
        });
        

        window.feature.symptomModal = Ext.define('Ext.feature.SymptomReport.Modal', {
            extend: 'Ext.window.Window',
            modal: true,
            ui: 'snapshot-popup-window',
            title: 'Symptom Report',
            height: 700,
            width: 1055,
            layout: {
                align: 'stretch',
                padding: 10,
                type: 'vbox'
            },

            initComponent: function () {
                var me = this;
                var countryOverviewCombobox = window.feature.container.down('#' + window.feature.countryComboboxId);
                var regionOverviewCombobox = window.feature.container.down('#' + window.feature.regionComboboxId);
                var districtOverviewCombobox = window.feature.container.down('#' + window.feature.districtComboboxId);
                var startDateOverviewCombobox = window.feature.container.down('#' + window.feature.StartDateId);
                var endDateOverviewCombobox = window.feature.container.down('#' + window.feature.EndDateId);
                var outpostTypeOverviewCombobox = window.feature.container.down('#' + window.feature.outpostTypeComboboxId);

                Ext.applyIf(me, {
                    items: [{
                        xtype: 'container',
                        height: 65,
                        layout: 'fit',
                        items: [{
                            xtype: 'container',
                            height: 65,
                            autoScroll: true,
                            scrollable:true,
                            layout: {
                                align: 'stretch',
                                type: 'hbox'
                            },
                            padding: '0 0 0 7',
                            items: [{
                                xtype: 'combobox',
                                itemId: window.feature.modalCountryComboboxId,
                                store: window.feature.countryStore,
                                width: 170,
                                labelAlign: 'top',
                                fieldLabel: 'Selected Country',
                                displayField: 'Name',
                                valueField: 'Id',
                                labelClsExtra: 'combo-label',
                                emptyText: 'Country List',
                                value: countryOverviewCombobox.getValue(),
                                editable: true,
                                typeAhead: true,
                                listeners: {
                                    'select': function (combo, record) {
                                        ResetCountryOverviewDependencies();
                                        countryOverviewCombobox.setValue(combo.getValue());
                                        me.down('#' + window.feature.modalRegionComboboxId).setValue(null);
                                        me.down('#' + window.feature.modalDistrictComboboxId).setValue(null);

                                        window.feature.regionStore.proxy.extraParams.countryId = combo.getValue();
                                        window.feature.regionStore.load();

                                        window.feature.chartStore.proxy.extraParams.countryId = combo.getValue();
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.countryId = combo.getValue();
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            countryOverviewCombobox.setValue(null);
                                            ResetCountryOverviewDependencies();
                                            me.down('#' + window.feature.modalRegionComboboxId).setValue(null);
                                            me.down('#' + window.feature.modalDistrictComboboxId).setValue(null);
                                            window.feature.chartStore.load();
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }, {
                                xtype: 'combobox',
                                itemId: window.feature.modalRegionComboboxId,
                                store: window.feature.regionStore,
                                width: 170,
                                labelAlign: 'top',
                                fieldLabel: 'Selected Region',
                                displayField: 'Name',
                                valueField: 'Id',
                                labelClsExtra: 'combo-label',
                                emptyText: 'Region List',
                                value: regionOverviewCombobox.getValue(),
                                editable: true,
                                typeAhead: true,
                                listeners: {
                                    'select': function (combo, record) {
                                        ResetRegionOverviewDependencies();
                                        regionOverviewCombobox.setValue(combo.getValue());
                                        me.down('#' + window.feature.modalDistrictComboboxId).setValue(null);

                                        window.feature.districtStore.proxy.extraParams.regionId = combo.getValue();
                                        window.feature.districtStore.load();

                                        window.feature.chartStore.proxy.extraParams.regionId = combo.getValue();
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.regionId = combo.getValue();
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            ResetRegionOverviewDependencies();
                                            regionOverviewCombobox.setValue(null);
                                            me.down('#' + window.feature.modalDistrictComboboxId).setValue(null);
                                            window.feature.chartStore.load();
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }, {
                                xtype: 'combobox',
                                itemId: window.feature.modalDistrictComboboxId,
                                store: window.feature.districtStore,
                                width: 170,
                                labelAlign: 'top',
                                fieldLabel: 'Selected District',
                                displayField: 'Name',
                                labelClsExtra: 'combo-label',
                                valueField: 'Id',
                                emptyText: 'District List',
                                value: districtOverviewCombobox.getValue(),
                                editable: true,
                                typeAhead: true,
                                listeners: {
                                    'select': function (combo, record) {
                                        districtOverviewCombobox.setValue(combo.getValue());

                                        window.feature.chartStore.proxy.extraParams.districtId = combo.getValue();
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.districtId = combo.getValue();
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            districtOverviewCombobox.setValue(null);
                                            window.feature.chartStore.proxy.extraParams.districtId = "";
                                            window.feature.chartStore.load();
                                            window.feature.symptomsStore.proxy.extraParams.districtId = "";
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }, {
                                xtype: 'datefield',
                                fieldLabel: 'Start Date',
                                width: 170,
                                format: 'd-M-Y',
                                labelAlign: 'top',
                                itemId: window.feature.modalStartDateId,
                                value: startDateOverviewCombobox.getValue(),
                                listeners: {
                                    select: function (t, n, o) {
                                        var date = t.getValue();
                                        window.feature.exportStartDate = date;
                                        startDateOverviewCombobox.setValue(date);
                                        window.feature.chartStore.proxy.extraParams.startDate = date;
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.startDate = date;
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            startDateOverviewCombobox.setValue(null);
                                            window.feature.chartStore.proxy.extraParams.startDate = "";
                                            window.feature.symptomsStore.proxy.extraParams.startDate = "";
                                            window.feature.exportStartDate = "";
                                            window.feature.chartStore.load();
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }, {
                                xtype: 'datefield',
                                fieldLabel: 'End Date',
                                width: 170,
                                labelAlign: 'top',
                                format: 'd-M-Y',
                                itemId: window.feature.modalEndDateId,
                                value: endDateOverviewCombobox.getValue(),
                                listeners: {
                                    select: function (t, n, o) {
                                        var date = t.getValue();
                                        window.feature.exportEndDate = date;
                                        endDateOverviewCombobox.setValue(date);
                                        window.feature.chartStore.proxy.extraParams.endDate = date;
                                        window.feature.chartStore.load();
                                        window.feature.symptomsStore.proxy.extraParams.endDate = date;
                                        window.feature.symptomsStore.load();
                                    },
                                    specialkey: function (field, e) {
                                        if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                            field.setValue(null);
                                            endDateOverviewCombobox.setValue(null);
                                            window.feature.chartStore.proxy.extraParams.endDate = "";
                                            window.feature.symptomsStore.proxy.extraParams.endDate = "";
                                            window.feature.exportEndDate = "";
                                            window.feature.chartStore.load();
                                            window.feature.symptomsStore.load();
                                        }
                                    }
                                }
                            }]
                        }]
                    },{
                        xtype: 'gridpanel',
                        cls: 'white-border',
                        store: window.feature.symptomReportStore,
                        loadMask: true,
                        disableSelection: true,
                        flex: 3,
                        layout: 'fit',
                        autoScroll: true,
                        features: [{
                            id: 'group',
                            ftype: 'groupingsummary',
                            enableGroupingMenu: false
                        }],
                        columns: [{
                            header: "Stymptom / Health Facility",
                            dataIndex: 'Outpost',
                            flex: 2,
                            minWidth: 200,
                            menuDisabled: true,
                            sortable: true
                        }, {
                            header: "Females",
                            dataIndex: 'Female',
                            flex: 1,
                            minWidth: 100,
                            menuDisabled: true,
                            sortable: true,
                            align: 'center',
                            summaryType: 'sum',
                            summaryRenderer: function (value, summaryData, dataIndex) {
                                return value + ' females';
                            },
                            field: {
                                xtype: 'numberfield'
                            }
                        }, {
                            header: "Males",
                            dataIndex: 'Male',
                            flex: 1,
                            minWidth: 100,
                            menuDisabled: true,
                            sortable: true,
                            align: 'center',
                            summaryType: 'sum',
                            summaryRenderer: function (value, summaryData, dataIndex) {
                                return value + ' males';
                            },
                            field: {
                                xtype: 'numberfield'
                            }
                        }, {
                            header: "Number Of Patients",
                            dataIndex: 'NumberOfPatients',
                            flex: 1,
                            minWidth: 150,
                            menuDisabled: true,
                            sortable: true,
                            align: 'center',
                            summaryType: 'sum',
                            summaryRenderer: function (value, summaryData, dataIndex) {
                                return value + ' patients';
                            },
                            field: {
                                xtype: 'numberfield'
                            }
                        }],
                        bbar: [{
                            xtype: 'button',
                            text: 'Export to Excel',
                            handler: function () {
                                DownloadFile("symptom");
                            }
                        }]
                    }]
                });

                me.callParent(arguments);
            }
        });


        window.feature.container = Ext.create('Ext.container.Container', {
            margin: '15 25 15 15',
            padding: '20 0 0 20',
            autoScroll: true,
            id: 'TopContainer',
            layout: {
                align: 'stretch',
                type: 'vbox'
            },
            items: [{
                xtype: 'container',
                height: 40,
                layout: {
                    align: 'stretch',
                    type: 'hbox'
                },
                items: [{
                    xtype: 'container',
                    height: 40,
                    flex: 1,
                    layout: {
                        type: 'column'
                    },
                    items: [{
                        xtype: 'container',
                        height: 30,
                        width: 30,
                        html: '&nbsp;'
                    }, {
                        xtype: 'label',
                        cls: 'x-title-label',
                        text: 'Symptom & Diagnosis Report'
                    }]
                }, {
                    xtype: 'container',
                    height: 40,
                    layout: {
                        type: 'hbox',
                        pack: 'end'
                    },
                    items: [
                        {
                            xtype: 'button',
                            margin: '0 10 0 20',
                            ui: 'snapshot-add-btn',
                            cls: 'x-add-button-gradient',
                            text: 'View Symptom Table',
                            handler: function () {
                                window.feature.symptomReportStore.load();
                                var winTabel = new window.feature.symptomModal({
                                    height: $(window).height()*80/100,
                                    width: $(window).width()*80/100,
                                });
                                winTabel.show();
                            }
                        },{
                            xtype: 'button',
                            margin: '0 10 0 20',
                            ui: 'snapshot-add-btn',
                            cls: 'x-add-button-gradient',
                            text: 'View Diagnosis Table',
                            handler: function () {
                                window.feature.reportStore.load();
                                var winTabel = new window.feature.modal({
                                    height: $(window).height()*80/100,
                                    width: $(window).width()*80/100,
                                });
                                winTabel.show();
                            }
                        },
                    ]
                }]
            }, {
                xtype: 'container',
                height: 65,
                layout: 'fit',
                items: [{
                    xtype: 'container',
                    height: 65,
                    autoScroll: true,
                    scrollable:true,
                    layout: {
                        align: 'stretch',
                        type: 'hbox'
                    },
                    items: [{
                        xtype: 'container',
                        height: 30,
                        width: 30,
                        html: '&nbsp;'
                    },
                        window.feature.countryCombobox,
                        window.feature.regionCombobox,
                        window.feature.districtCombobox,
                    {
                        xtype: 'datefield',
                        fieldLabel: 'Start Date',
                        width: 170,
                        format: 'd-M-Y',
                        labelAlign: 'top',
                        itemId: window.feature.StartDateId,
                        listeners: {
                            select: function (t, n, o) {
                                var date = t.getValue();
                                window.feature.exportStartDate = date;
                                window.feature.chartStore.proxy.extraParams.startDate = date;
                                window.feature.chartStore.load();
                                window.feature.symptomsStore.proxy.extraParams.startDate = date;
                                window.feature.symptomsStore.load();
                            },
                            specialkey: function (field, e) {
                                if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                    field.setValue(null);
                                    window.feature.chartStore.proxy.extraParams.startDate = "";
                                    window.feature.symptomsStore.proxy.extraParams.startDate = "";
                                    window.feature.exportStartDate = "";
                                    window.feature.chartStore.load();
                                    window.feature.symptomsStore.load();
                                }
                            }
                        }
                    }, {
                        xtype: 'datefield',
                        fieldLabel: 'End Date',
                        labelAlign: 'top',
                        width: 170,
                        format: 'd-M-Y',
                        itemId: window.feature.EndDateId,
                        listeners: {
                            select: function (t, n, o) {
                                var date = t.getValue();
                                window.feature.exportEndDate = date;
                                window.feature.chartStore.proxy.extraParams.endDate = date;
                                window.feature.chartStore.load();
                                window.feature.symptomsStore.proxy.extraParams.endDate = date;
                                window.feature.symptomsStore.load();
                            },
                            specialkey: function (field, e) {
                                if (e.getKey() == e.BACKSPACE || e.getKey() == e.DELETE) {
                                    field.setValue(null);
                                    window.feature.chartStore.proxy.extraParams.endDate = "";
                                    window.feature.symptomsStore.proxy.extraParams.endDate = "";
                                    window.feature.exportEndDate = "";
                                    window.feature.chartStore.load();
                                    window.feature.symptomsStore.load();
                                }
                            }
                        }
                    }]
                }]
            }, {
                flex: 1,
                layout: 'fit',
                padding: '3 10 0 0',
                items: [{
                    xtype: 'container',
                    id: window.feature.DivChartContainer,
                    flex: 1,
                    layout: 'fit',
                    scrollable:true,
                    autoScroll: true,
                    items:[
                            window.feature.chartContainer
                        ]
                }]
            }, {
                xtype: 'container',
                height: 10
            }]
        });

        function DownloadFile(type) {
            var body = Ext.getBody();

            var frame = body.createChild({
                tag: 'iframe',
                cls: 'x-hidden',
                id: 'iframe',
                name: 'iframe'
            });


            var url = '';
            
            if(type==null || type==undefined || type=="" || type=="diagnosis") {
                url = '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "DiagnosisReport", action = "ExportToExcel" })';
            }
            else if(type=="symptom") {
                url = '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "SymptomsReport", action = "ExportToExcel" })';
            }
            
            var form=body.createChild({
                    tag: 'form',
                    cls: 'x-hidden',
                    id: 'form',
                    method: 'POST',
                    action: url,
                    target: 'iframe'
                });

            var countryInput = form.createChild({
                tag: 'input',
                type: 'hidden',
                name: 'countryId',
                value: window.feature.reportStore.proxy.extraParams.countryId
            });

            var regionInput = form.createChild({
                tag: 'input',
                type: 'hidden',
                name: 'regionId',
                value: window.feature.reportStore.proxy.extraParams.regionId
            });

            var districtInput = form.createChild({
                tag: 'input',
                type: 'hidden',
                name: 'districtId',
                value: window.feature.reportStore.proxy.extraParams.districtId
            });

            var startDateValue = "";
            if (window.feature.exportStartDate != "")
                startDateValue = Ext.Date.format(window.feature.exportStartDate, 'd-M-Y');

            var startDateInput = form.createChild({
                tag: 'input',
                type: 'hidden',
                name: 'startDate',
                value: startDateValue
            });

            var endDateValue = "";
            if (window.feature.exportEndDate != "")
                endDateValue = Ext.Date.format(window.feature.exportEndDate, 'd-M-Y');

            var endDateInput = form.createChild({
                tag: 'input',
                type: 'hidden',
                name: 'endDate',
                value: endDateValue
            });

            form.dom.submit();
        }
        


        function GetTheBiggestValue() {
            var maxSum = 0;
            window.feature.chartStore.each(function (record) {
                var sum = record.get('Male') + record.get('Female');
                if (sum > maxSum)
                    maxSum = sum;
            });

            if (maxSum == 1)
                maxSum = 2;

            return maxSum;
        }
        
        function GetMaxSymptomValue() {
            var maxSum = 0;
            window.feature.symptomsStore.each(function (record) {
                var sum = record.get('Male') + record.get('Female');
                if (sum > maxSum)
                    maxSum = sum;
            });

            if (maxSum == 1)
                maxSum = 2;

            return maxSum;
        }

        var contentRes = window.res.content;
        var mainContent = Ext.getCmp(contentRes.maincontent.id);

        mainContent.add(window.feature.container);
        window.feature.chartStore.load();
        window.feature.symptomsStore.load();
    });
</script>