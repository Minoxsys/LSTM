@using Domain
@using Microsoft.Web.Mvc;
@using Web.Areas.AnalysisManagement;
@using Web.Areas.LocationManagement;

@section page_title{
Analysis: Product level information at district level
}

@{
    Html.RenderPartial("_EmptySubNavigation");
    Html.RenderPartial("_AnalysisSideBar");
    Html.RenderPartial("SelectPositionGoogleMapWindow");
}

<script type="text/javascript">

    Ext.onReady(function () {

        var analysisBtnId = window.res.header.navigation.analysisAndReports;
        var analysisBtn = Ext.getCmp(analysisBtnId);
        analysisBtn.toggle(true);

        var reportBtnId = window.res.content.maincontent.sidebar.googlemaps;
        var reportBtn = Ext.getCmp(reportBtnId);
        reportBtn.toggle(true);
    });

</script>

<script type="text/javascript">
    Ext.onReady(function () {
        window.feature = {};
        window.feature.countryComboboxId = "Country-Combo-Box-Google-Map-Report";

        var outpostMarkersArray = [];
        var districtMarkersArray = [];
        var regionMarkersArray = [];

        var googleMapPanelConfig = { flex: 1, margin: '0 0 10 0' };
        googleMapPanelConfig.centerPosition = new google.maps.LatLng(34.321061139205526, 66.34764831250004);
        googleMapPanelConfig.zoom = 2;
        var googleMapPanel = Ext.create('Ext.feature.GoogleMapPanel', googleMapPanelConfig);

        window.feature.outpostStore = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Number', 'Type', 'Coordonates', 'FemaleYounger', 'FemaleOlder', 'MaleYounger', 'MaleOlder'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(Web.Areas.AnalysisManagement.AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "GoogleMapReport", action = "GetOutpostMarkers" })',
                reader: {
                    type: 'json',
                    root: 'Markers',
                    totalProperty: 'TotalItems'
                },
                extraParams: { countryId: '' }
            }
        });

        window.feature.districtStore = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Number', 'Type', 'Coordonates', 'FemaleYounger', 'FemaleOlder', 'MaleYounger', 'MaleOlder'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(Web.Areas.AnalysisManagement.AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "GoogleMapReport", action = "GetDistrictMarkers" })',
                reader: {
                    type: 'json',
                    root: 'Markers',
                    totalProperty: 'TotalItems'
                },
                extraParams: { countryId: '' }
            }
        });

        window.feature.regionStore = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Number', 'Type', 'Coordonates', 'FemaleYounger', 'FemaleOlder', 'MaleYounger', 'MaleOlder'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(Web.Areas.AnalysisManagement.AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "GoogleMapReport", action = "GetRegionMarkers" })',
                reader: {
                    type: 'json',
                    root: 'Markers',
                    totalProperty: 'TotalItems'
                },
                extraParams: { countryId: '' }
            }
        });

        window.feature.countryStore = Ext.create('Ext.data.Store', {
            remoteSort: true,
            fields: ['Id', 'Name'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(Web.Areas.LocationManagement.LocationManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "Region", action = "GetCountries" })',
                reader: {
                    type: 'json',
                    root: 'Countries',
                    totalProperty: 'TotalItems'
                },
                simpleSortMode: true
            },
            sorters: [{
                property: 'Name',
                direction: 'ASC'
            }]
        });

        window.feature.country = Ext.create('Ext.form.ComboBox', {
            xtype: 'combobox',
            itemId: window.feature.countryComboboxId,
            store: window.feature.countryStore,
            margin: '0 0 20 50',
            fieldLabel: 'Select Country',
            displayField: 'Name',
            valueField: 'Id',
            labelClsExtra: 'combo-label',
            emptyText: 'Country List',
            editable: false,
            typeAhead: false,
            listeners: {
                'select': function (combo, record) {
                    var map = googleMapPanel.getMap();

                    window.feature.outpostStore.proxy.extraParams.countryId = combo.getValue();
                    window.feature.outpostStore.load();
                    window.feature.districtStore.proxy.extraParams.countryId = combo.getValue();
                    window.feature.districtStore.load();
                    window.feature.regionStore.proxy.extraParams.countryId = combo.getValue();
                    window.feature.regionStore.load(function () {
                        map.setZoom(4);
                    });

                    deleteMarkers(regionMarkersArray);
                    deleteMarkers(districtMarkersArray);
                    deleteMarkers(regionMarkersArray);

                    centerOnPlace(combo.getRawValue(), map);
                }
            }
        });

        window.feature.container = Ext.create('Ext.container.Container', {
            margin: '45 50 20 20',
            padding: '20 0 0 20',
            autoScroll: true,
            id: 'TopContainer',
            layout: {
                align: 'stretch',
                type: 'hbox'
            },
            items: [{
                xtype: 'container',
                flex: 1,
                layout: {
                    align: 'stretch',
                    type: 'vbox'
                },
                items: [{
                    xtype: 'container',
                    layout: {
                        align: 'stretch',
                        type: 'vbox'
                    },
                    height: 35,
                    items: [{
                        xtype: 'container',
                        flex: 1,
                        layout: {
                            type: 'column'
                        },
                        items: [{
                            xtype: 'container',
                            height: 30,
                            width: 30,
                            html: '&nbsp;'
                        }, {
                            xtype: 'label',
                            cls: 'x-title-label',
                            text: 'Google Map Report'
                        }, window.feature.country
                        ]
                    }]
                }, {
                    xtype: 'container',
                    flex: 1,
                    layout: {
                        align: 'stretch',
                        type: 'vbox'
                    },
                    items: [
                        googleMapPanel
                    ]
                }]
            }]
        });

        function centerOnPlace(country, map) {
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': country }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    map.setCenter(results[0].geometry.location);
                }
            });
        };

        function getGooglePositionFromText(coordinates) {
            var a = parseFloat(coordinates.substring(1, coordinates.indexOf(',')));
            var b = parseFloat(coordinates.substring(coordinates.indexOf(',') + 1, coordinates.length - 1));
            return new google.maps.LatLng(a, b);
        };

        function deleteMarkers(markerArray) {
            var number = markerArray.length;

            if (markerArray) {
                for (var j = 0; j < markerArray.length; j++) {
                    markerArray[j].setMap(null);
                }
            }
            markerArray.splice(0, number);
            markerArray = [];

        };

        function createMarker(store, markerArray, map) {
            var a = markerArray.length;

            if (markerArray.length == 0) {
                var i = 0;

                store.each(function (item) {
                    var marker = new MarkerWithLabel({
                        position: getGooglePositionFromText(item.get('Coordonates')),
                        draggable: false,
                        raiseOnDrag: true,
                        map: map,
                        labelContent: item.get('Number'),
                        labelAnchor: new google.maps.Point(15, 0),
                        labelClass: item.get('Type'),
                        title: item.get('Name'),
                        animation: google.maps.Animation.DROP
                    });

                    var infowindow = new google.maps.InfoWindow({
                        content: "<h1>" + marker.title + "</h1><br/><p><h3>Female</h3></p><p>Younger than 20 years: " + item.get('FemaleYounger') + "</p><p>Older than 20 years: " + item.get('FemaleOlder') + "</p><br/><p><h3>Male</h3></p><p>Younger than 20 years: " + item.get('MaleYounger') + "</p><p>Older than 20 years: " + item.get('MaleOlder') + "</p>"
                    });

                    google.maps.event.addListener(marker, 'click', function () {
                        infowindow.open(map, marker);
                    });

                    markerArray[i] = marker;
                    i = i + 1;
                }, this);
            }
        }

        function SetUpZoomEvent() {
            var map = googleMapPanel.getMap();

            google.maps.event.addListener(map, 'zoom_changed', function () {
                var zoomLevel = map.getZoom();

                if (map.getZoom() >= 7) {
                    deleteMarkers(regionMarkersArray);
                    deleteMarkers(districtMarkersArray);
                    createMarker(window.feature.outpostStore, outpostMarkersArray, map);
                }

                if (map.getZoom() < 7 && map.getZoom() >= 5) {
                    deleteMarkers(outpostMarkersArray);
                    deleteMarkers(regionMarkersArray);
                    createMarker(window.feature.districtStore, districtMarkersArray, map);
                }

                if (map.getZoom() < 5) {
                    deleteMarkers(districtMarkersArray);
                    deleteMarkers(outpostMarkersArray);
                    createMarker(window.feature.regionStore, regionMarkersArray, map);
                }

            });
        }


        var contentRes = window.res.content;
        var mainContent = Ext.getCmp(contentRes.maincontent.id);

        mainContent.add(window.feature.container);
        window.feature.countryStore.load(function () {
            SetUpZoomEvent();
        });
    });
</script>

<style type="text/css">
.drugshop {
   color: black;
   background-color: #FFCCCC;
   font-family: "Lucida Grande", "Arial", sans-serif;
   font-size: 10px;
   font-weight: bold;
   text-align: center;
   width: 30px;     
   border: 1px solid black;
   white-space: nowrap;
}
.dispensary {
   color: black;
   background-color: #FFFF66;
   font-family: "Lucida Grande", "Arial", sans-serif;
   font-size: 10px;
   font-weight: bold;
   text-align: center;
   width: 30px;     
   border: 1px solid black;
   white-space: nowrap;
}
.healthcenter {
   color: black;
   background-color: #99FFFF;
   font-family: "Lucida Grande", "Arial", sans-serif;
   font-size: 10px;
   font-weight: bold;
   text-align: center;
   width: 30px;     
   border: 1px solid black;
   white-space: nowrap;
}
</style>